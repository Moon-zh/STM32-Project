#include "sys.h"	
#include "rs485.h"	 
#include "delay.h"
#include "LED_dz.h"
//#include "check.h"
extern u16 CalcCRC(u8 *data, u16 size);
u8 tab_dz_hand[]={0XA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x62,0x02,0x05,0x00,0xA2,0x00,0x01,0x00,0x00,0x91,0xFE,0x5A};
u8 tab_dz_set1[]={0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x62,0x02,0x0E,0x00,0xA1,0x05,0x01,0x00,0x00,0x01,0x50,0x30,0x30,0x31,0xCF,0x00,0x00,0x00,0x18,0xE0,0x5A};

u8 tab_dz1[]={	0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x62,0x02,0xE1,0x00,0xA1,0x06,0x01,0x00,0x00,0x50,0x30,0x30,0x31,0x01,0x00,0x00,0xCF,0x00,0x00,0x00,
				0x00,0x00,0x00,0x50,0x30,0x30,0x31,0xCF,0x00,0x00,0x00,0xFF,0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x00,0x02,0x57,0x00,0x00,
				0x00,0x00,0x00,0x80,0x00,0x00,0x40,0x80,0x10,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x00,0x0D,0x00,0x38,0x00,0x00,0x00,0xBF,0xD5,
				0xC6,0xF8,0xCE,0xC2,0xB6,0xC8,0x3A,0x32,0x35,0xA1,0xE6,0x20,0x43,0x4F,0x32,0x3A,0x32,0x33,0x33,0x70,0x70,0x6D,0x20,0x20,0x20,0x20,0x20,0xCD,0xC1,0xC8,
				0xC0,0xCE,0xC2,0xB6,0xC8,0x3A,0x32,0x31,0xA1,0xE6,0x20,0x45,0x43,0x3A,0x32,0x35,0x34,0xA6,0x01,0xCC,0x67,0x2F,0x63,0x6D,0x20,0x5D,0x00,0x00,0x00,0x00,
				0x00,0x80,0x10,0x00,0x40,0x80,0x20,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x03,0x00,0x0D,0x00,0x3E,0x00,0x00,0x00,0xBF,0xD5,0xC6,0xF8,
				0xCA,0xAA,0xB6,0xC8,0x3A,0x37,0x35,0x25,0x20,0x20,0xB9,0xE2,0xD5,0xD5,0xC7,0xBF,0xB6,0xC8,0x3A,0x30,0x37,0x32,0x35,0x34,0x38,0x4C,0x20,0xCD,0xC1,0xC8,
				0xC0,0xCA,0xAA,0xB6,0xC8,0x3A,0x38,0x30,0x25,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x6E,0xBC,
				0xD2,0x71,0x5A};

void insert(int i,int x)	//数组插入元素
{
    int j;
	for(j=sizeof(tab_dz1)-2;j>i-1;j--)tab_dz1[j+1]=tab_dz1[j];    
	tab_dz1[i]=x;                
}

void del(int i)				//输入删除元素
{
    int j;
	for(j=i;j<sizeof(tab_dz1);j++)tab_dz1[j] = tab_dz1[j+1];
}				
				
void	senddzcmd(u8 *data,u8 num)
{
	comSendBuf(COM4,data,num);
}

void	setdz1(u8 addr,Environmental data)//数据域
{
	u8 i=0;
	char *h1="空气温度:25℃ CO2:0233ppm    土壤温度:21℃ EC:254μg/cm ";
	char *h2="空气湿度:75% 光照强度:072548L  土壤湿度:80%                   ";
	u16 crc;
	for(;*h1;h1++)tab_dz1[88+i++]=*h1;i=0;
	del(144);
	for(;*h2;h2++)tab_dz1[175+i++]=*h2;

	
	tab_dz1[88+sizeof("空气温度:")-1]=data.airtemp/100+0x30;
	tab_dz1[88+sizeof("空气温度:")]=data.airtemp%100/10+0x30;
	
	tab_dz1[88+sizeof("空气温度:25℃ CO2:")-1]=data.CO2%10000/1000+0x30;
	tab_dz1[88+sizeof("空气温度:25℃ CO2:")]=data.CO2%1000/100+0x30;
	tab_dz1[88+sizeof("空气温度:25℃ CO2:")+1]=data.CO2%100/10+0x30;
	tab_dz1[88+sizeof("空气温度:25℃ CO2:")+2]=data.CO2%10+0x30;
	
	tab_dz1[88+sizeof("空气温度:25℃ CO2:233ppm     土壤温度:")-1]=data.soiltemp/100+0x30;
	tab_dz1[88+sizeof("空气温度:25℃ CO2:233ppm     土壤温度:")]=data.soiltemp%100/10+0x30;

	tab_dz1[88+sizeof("空气温度:25℃ CO2:233ppm     土壤温度:21℃ EC:")-1]=data.EC%1000/100+0x30;
	tab_dz1[88+sizeof("空气温度:25℃ CO2:233ppm     土壤温度:21℃ EC:")]=data.EC%100/10+0x30;
	tab_dz1[88+sizeof("空气温度:25℃ CO2:233ppm     土壤温度:21℃ EC:")+1]=data.EC%10+0x30;
	
	
	tab_dz1[175+sizeof("空气湿度:")-1]=data.soiltemp/100+0x30;
	tab_dz1[175+sizeof("空气湿度:")]=data.soiltemp%100/10+0x30;
	
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:")-1]=data.light/100000+0x30;
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:")]=data.light/10000%10+0x30;
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:")+1]=data.light%10000/1000+0x30;
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:")+2]=data.light%1000/100+0x30;
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:")+3]=data.light%100/10+0x30;
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:")+4]=data.light%10+0x30;
	
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:072548L  土壤湿度:")-1]=data.soilhumi/100+0x30;
	tab_dz1[175+sizeof("空气湿度:75% 光照强度:072548L  土壤湿度:")]=data.soilhumi%100/10+0x30;

	
	crc=CalcCRC(tab_dz1+32,sizeof(tab_dz1)-38);
	tab_dz1[sizeof(tab_dz1)-5]=crc>>8;
	tab_dz1[sizeof(tab_dz1)-6]=crc&0xff;
	
	crc=CalcCRC(tab_dz1,sizeof(tab_dz1)-4);
	tab_dz1[sizeof(tab_dz1)-3]=crc>>8;
	tab_dz1[sizeof(tab_dz1)-4]=crc&0xff;
	insert(138,1);
	
	for(i=0;i<8;i++)comSendChar(COM4,0xA5);
	comSendBuf(COM4,tab_dz1,sizeof(tab_dz1));
}

void	setprogram1(u8 addr ,Environmental data)	//设置节目
{
	u8 i;
	u8 a[40];
	i=0;
	do
	{
		senddzcmd(tab_dz_set1,sizeof(tab_dz_set1));
		delay_ms(500);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}while(1);delay_ms(100);
	
	i=0;
	comClearRxFifo(COM4);
	do
	{
		setdz1(addr,data);
		delay_ms(500);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}
	while(1);delay_ms(100);
}

void	setdz()
{
	u8 i=0;
	u8 a[40];
	do
	{
		senddzcmd(tab_dz_hand,sizeof(tab_dz_hand));
		delay_ms(500);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}while(1);delay_ms(100);
}
