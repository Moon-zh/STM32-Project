#include "sys.h"	
#include "rs485.h"	 
#include "delay.h"
#include "LED_dz.h"
//#include "check.h"
extern u16 CalcCRC(u8 *data, u16 size);
u8 tab_dz_hand[]={0XA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x58,0x02,0x05,0x00,0xA2,0x00,0x01,0x00,0x00,0xBB,0x5F,0x5A};
u8 tab_dz_set1[]={0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x58,0x02,0x0E,0x00,0xA1,0x05,0x01,0x00,0x00,0x01,0x50,0x30,0x30,0x31,0x79,0x00,0x00,0x00,0x12,0x7D,0x5A};
u8 tab_dz_set2[]={0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0xA5,0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x58,0x02,0x0E,0x00,0xA1,0x05,0x01,0x00,0x00,0x01,0x50,0x30,0x30,0x32,0x79,0x00,0x00,0x00,0x56,0x7D,0x5A};	

u8 tab_dz1[]={0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x58,0x02,0x8B,0x00,0xA1,0x06,0x01,0x00,0x00,0x50,0x30,0x30,0x31,0x01,0x00,0x00,0x79,0x00,0x00,0x00,
	0x00,0x00,0x00,0x50,0x30,0x30,0x31,0x79,0x00,0x00,0x00,0xFF,0x05,0x00,0x05,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x00,0x01,0x5E,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x40,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x02,0x01,0x00,0x05,0x0A,0x3F,0x00,0x00,0x00,0xCE,0xC2,
	0xCA,0xD2,0x31,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x43,0x4F,0x32,0xA3,0xBA,0x33,0x31,0x35,0x32,0x70,0x70,0x6D,0x20,0x20,0xBF,0xD5,0xC6,0xF8,
	0xCE,0xC2,0xB6,0xC8,0xA3,0xBA,0x32,0x37,0xA1,0xE6,0xBF,0xD5,0xC6,0xF8,0xCA,0xAA,0xB6,0xC8,0xA3,0xBA,0x33,0x39,0x25,0x52,0x48,0x71,0x7C,0x68,0x6B,0x5A,
	0x00,0x00,0x00,0x00,0x00,0x5A};
u8 tab_dz2[]={0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x58,0x02,0x8B,0x00,0xA1,0x06,0x01,0x00,0x00,0x50,0x30,0x30,0x32,0x01,0x00,0x00,0x79,0x00,0x00,0x00,
	0x00,0x00,0x00,0x50,0x30,0x30,0x32,0x79,0x00,0x00,0x00,0xFF,0x05,0x00,0x05,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x00,0x01,0x5E,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x40,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x02,0x01,0x00,0x05,0x0A,0x3F,0x00,0x00,0x00,0xCE,0xC2,
	0xCA,0xD2,0x31,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0xCD,0xC1,0xC8,0xC0,0xCE,0xC2,0xB6,0xC8,0xA3,0xBA,0x32,0x33,0xA1,0xE6,0xCD,0xC1,0xC8,0xC0,
	0xCA,0xAA,0xB6,0xC8,0xA3,0xBA,0x34,0x36,0x25,0x52,0x48,0xB9,0xE2,0xD5,0xD5,0xA3,0xBA,0x32,0x35,0x34,0x31,0x38,0x4C,0x75,0x78,0xD6,0xFB,0x29,0xA8,0x5A,
	0x00,0x00,0x00,0x00,0x00,0x5A};
	
void	senddzcmd(u8 *data,u8 num)
{
	comSendBuf(COM4,data,num);
}

void	setdz1(u8 addr,Environmental data)//78
{
	u8 i=0;
	char *h1="ÎÂÊÒ            ";	
	char *h2="CO2£º3152ppm    ";	
	char *h3="¿ÕÆøÎÂ¶È£º27¡æ  ";	
	char *h4="¿ÕÆøÊª¶È£º39%RH";	
	u16 crc;

	for(;*h1;h1++)tab_dz1[88+i++]=*h1;
	for(;*h2;h2++)tab_dz1[88+i++]=*h2;
	for(;*h3;h3++)tab_dz1[88+i++]=*h3;
	for(;*h4;h4++)tab_dz1[88+i++]=*h4;
	
	tab_dz1[42]=10;
	
	tab_dz1[88+sizeof("ÎÂÊÒ")-1]=addr+0x30;
	
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º")-1]=data.CO2%10000/1000+0x30;
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º")]=data.CO2%1000/100+0x30;
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º")+1]=data.CO2%100/10+0x30;
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º")+2]=data.CO2%10+0x30;
	
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º3152ppm    ¿ÕÆøÎÂ¶È£º")-1]=data.airtemp/100+0x30;
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º3152ppm    ¿ÕÆøÎÂ¶È£º")]=data.airtemp%100/10+0x30;
	
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º3152ppm    ¿ÕÆøÎÂ¶È£º27¡æ  ¿ÕÆøÊª¶È£º")-1]=data.airhumi/100+0x30;
	tab_dz1[88+sizeof("ÎÂÊÒ1           CO2£º3152ppm    ¿ÕÆøÎÂ¶È£º27¡æ  ¿ÕÆøÊª¶È£º")]=data.airhumi%100/10+0x30;
	
	
	crc=CalcCRC(tab_dz1+32,sizeof(tab_dz1)-37);
	tab_dz1[sizeof(tab_dz1)-4]=crc>>8;
	tab_dz1[sizeof(tab_dz1)-5]=crc&0xff;
	
	crc=CalcCRC(tab_dz1,sizeof(tab_dz1)-3);
	tab_dz1[sizeof(tab_dz1)-2]=crc>>8;
	tab_dz1[sizeof(tab_dz1)-3]=crc&0xff;
	
	for(i=0;i<8;i++)comSendChar(COM4,0xA5);
	tab_dz1[sizeof(tab_dz1)-1]=0x5A;
	comSendBuf(COM4,tab_dz1,sizeof(tab_dz1));
}

void	setdz2(u8 addr,Environmental data)
{
	u8 i=0;
	char *h1="ÎÂÊÒ1           ";	
	char *h2="ÍÁÈÀÎÂ¶È£º54¡æ  ";	
	char *h3="ÍÁÈÀÊª¶È£º91%RH ";	
	char *h4="¹âÕÕ£º 14682Lux ";	
	u16 crc;

	for(;*h1;h1++)tab_dz2[88+i++]=*h1;
	for(;*h2;h2++)tab_dz2[88+i++]=*h2;
	for(;*h3;h3++)tab_dz2[88+i++]=*h3;
	for(;*h4;h4++)tab_dz2[88+i++]=*h4;
	
	tab_dz2[42]=10;
	
	tab_dz2[88+sizeof("ÎÂÊÒ")-1]=addr+0x30;
	
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º")-1]=data.soiltemp/100+0x30;
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º")]=data.soiltemp%100/10+0x30;
	
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º")-1]=data.soilhumi/100+0x30;
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º")]=data.soilhumi%100/10+0x30;
	
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º %RH  ¹âÕÕ£º ")-2]=data.light/100000+0x30;
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º %RH  ¹âÕÕ£º ")-1]=data.light/10000%10+0x30;
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º %RH  ¹âÕÕ£º ")]=data.light%10000/1000+0x30;
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º %RH  ¹âÕÕ£º ")+1]=data.light%1000/100+0x30;
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º %RH  ¹âÕÕ£º ")+2]=data.light%100/10+0x30;
	tab_dz2[88+sizeof("ÎÂÊÒ1           ÍÁÈÀÎÂ¶È£º  ¡æ  ÍÁÈÀÊª¶È£º %RH  ¹âÕÕ£º ")+3]=data.light%10+0x30;
	
	crc=CalcCRC(tab_dz2+32,sizeof(tab_dz2)-37);
	tab_dz2[sizeof(tab_dz2)-4]=crc>>8;
	tab_dz2[sizeof(tab_dz2)-5]=crc&0xff;
	
	crc=CalcCRC(tab_dz2,sizeof(tab_dz2)-3);
	tab_dz2[sizeof(tab_dz2)-2]=crc>>8;
	tab_dz2[sizeof(tab_dz2)-3]=crc&0xff;
	
	for(i=0;i<8;i++)comSendChar(COM4,0xA5);
	tab_dz2[sizeof(tab_dz2)-1]=0x5A;
	comSendBuf(COM4,tab_dz2,sizeof(tab_dz2));
}

void	setprogram1(u8 addr ,Environmental data)
{
	u8 i;
	u8 a[40];
	i=0;
	do
	{
		senddzcmd(tab_dz_set1,sizeof(tab_dz_set1));
		delay_ms(500);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}while(1);delay_ms(100);
	
	i=0;
	comClearRxFifo(COM4);
	do
	{
		setdz1(addr,data);
		delay_ms(500);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}
	while(1);delay_ms(100);
}

void	setprogram2(u8 addr ,Environmental data)
{
	u8 a[40];
	u8 i;
	i=0;
	do
	{
		senddzcmd(tab_dz_set2,sizeof(tab_dz_set2));
		delay_ms(500);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}while(1);delay_ms(100);
	
	comClearRxFifo(COM4);
	i=0;
	do
	{
		setdz2(addr,data);
		delay_ms(300);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}while(1);delay_ms(100);
}

void	setdz()
{
	u8 i=0;
	u8 a[40];
	do
	{
		senddzcmd(tab_dz_hand,sizeof(tab_dz_hand));
		delay_ms(500);
		if(COM4GetBuf(a,35)>30)break;
		if(++i==10)return;
	}while(1);delay_ms(100);
}
